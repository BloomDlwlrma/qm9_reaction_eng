#!/bin/bash
#################################################################################
## SLURM Submission Script for All Atom Calculations                            #
#################################################################################
#SBATCH --job-name=orca-atoms                     # Job name
#SBATCH --partition=intel                         # Partition
#SBATCH --nodes=1                                 # Number of nodes
#SBATCH --ntasks=32                               # Total number of cores
#SBATCH --time=30:00:00                           # Walltime (30 hours)
#SBATCH --output=%x.out.%j                        # Standard output
#SBATCH --error=%x.err.%j                         # Standard error

#################################################################################
# Config & Arrays
#################################################################################
#ATOMS=("C" "H" "O" "N" "F")
#METHODS=("MP2" "CCSD" "CCSD(T)")
#BASIS_SETS=("631g" "631gs" "631gss" "631+gss" "def2svp" "def2tzvp" "ccpvdz" "ccpvtz" "321g")

# Testing to debugging
ATOMS=("C")
METHODS=("CCSD")
BASIS_SETS=("ccpvtz")

#################################################################################
# Setup Environment
#################################################################################
# Load ORCA 
export ORCA_HOME=/lustre1/g/chem_yangjun/orca6.1.0/orca-6.1.0-f.0_linux_x86-64
export PATH=${ORCA_HOME}/bin:$PATH
export LD_LIBRARY_PATH=${ORCA_HOME}/lib:$LD_LIBRARY_PATH

# OpenMPI Configuration (Crucial for performance and stability)
# export OMP_NUM_THREADS=1                    # Ensure 1 MPI process per core, avoid thread oversubscription
# mkdir -p "${SCRATCH_ROOT}/ompi_${SLURM_JOB_ID}"
# export OMPI_MCA_orte_tmpdir_base="${SCRATCH_ROOT}/ompi_${SLURM_JOB_ID}" # Avoid filling /tmp

cd ${SLURM_SUBMIT_DIR}
NPROCS=${SLURM_NTASKS}
WORK_DIR=$(pwd)

# Define clean_up  for trap
function clean_up() {
  if [ "${FINISHED}" != "1" ]; then
    echo "Job terminated early. Cleaning up..."
    # In-place run cleanup (if needed)
    if [ -f "${TMP_INP}" ]; then
        rm -f "${TMP_INP}"
    fi
    exit 255
  fi
}

trap clean_up SIGHUP SIGINT SIGTERM SIGABRT

#################################################################################
# Main Loop
#################################################################################
echo "Job Start Time: $(date)"
echo "Running on node: $(hostname)"
echo "Work Directory: ${WORK_DIR}"

FINISHED="0"

for atom in "${ATOMS[@]}"; do
    atom_lc="${atom,,}" # Convert to lowercase
    
    for basis_key in "${BASIS_SETS[@]}"; do
        for method in "${METHODS[@]}"; do
            
            method_file="${method//(/}"
            method_file="${method_file//)/}"
            method_lc="${method_file,,}"
            
            JOBNAME="${atom_lc}_${method_lc}_${basis_key}"
            ATOM_DIR="${WORK_DIR}/${atom_lc}"
            INFILE="${ATOM_DIR}/${JOBNAME}.inp"
            OUTFILE="${ATOM_DIR}/${JOBNAME}.out"
            
            if [[ ! -f "${INFILE}" ]]; then
                echo "WARNING: Input file missing: ${INFILE}. Skipping." 
                continue
            fi
            
            # Check if already done
            if [[ -e "${OUTFILE}" ]]; then
                echo "SKIPPING: ${JOBNAME} (Output exists)"
                continue
            fi

            echo "----------------------------------------------------------------"
            echo "Processing (In-Place): ${JOBNAME}"
            
            # Run In-Place (Simplified)
            # Use a subshell to change dir safely
            (
                cd "${ATOM_DIR}" || exit 1
                
                # Construct temporary input with parallel header
                TMP_INP="${JOBNAME}.run.inp"
                echo "%pal nprocs ${NPROCS} end" > "${TMP_INP}"
                cat "${INFILE}" >> "${TMP_INP}"

                echo "Running ORCA..."
                time ${ORCA_HOME}/bin/orca "${TMP_INP}" > "${JOBNAME}.out"
                
                # Cleanup temporary run input
                rm -f "${TMP_INP}"
            )
            
            echo "Finished: ${JOBNAME} at $(date)"
            echo "----------------------------------------------------------------"

        done
    done
done

FINISHED="1"
echo "All Done. Job Finish Time: $(date)"
exit 0
